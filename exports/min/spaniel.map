{"version":3,"sources":["utils.js","metal/window-proxy.js","metal/engine.js","metal/scheduler.js","metal/events.js","intersection-observer.js","spaniel-observer.js","watcher.js","index.js","metal/queue.js"],"names":["calculateIsIntersecting","_a","intersectionRect","width","height","getBoundingClientRect","element","e","number","top","bottom","left","right","x","y","invalidate","W","version","hasDomSetup","se","document","scrollingElement","getScrollTop","scrollTop","window","scrollY","getScrollLeft","scrollLeft","scrollX","setGlobalEngine","engine","globalEngine","getGlobalEngine","Engine","generateToken","tokenCounter","TOKEN_SEED","getGlobalScheduler","globalScheduler","Scheduler","getEventStore","eventStore","scroll","RAFEventRecord","frame","this","state","resize","destroy","GenericEventRecord","beforeunload","hide","show","on","eventName","callback","evt","listen","off","unlisten","trigger","value","scheduleWork","scheduleRead","marginToRect","margin","rootMarginToDOMMargin","rootMargin","c","split","map","n","parseInt","length","addRatio","entryInit","unixTime","highResTime","rootBounds","boundingClientRect","target","boundingArea","time","intersectionRatio","isIntersecting","emptyRect","generateEntry","clientRect","el","style","display","dateNow","intersectX","Math","max","intersectY","min","interLeft","interTop","DOMMarginToRootMargin","d","onEntry","entries","forEach","entry","label","duration","opts","visibleTime","entering","payload","queryElement","elementSatisfiesRatio","ratio","__extends","extendStatics","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","BaseQueue","items","remove","identifier","len","i","removePredicate","splice","clear","push","isEmpty","Queue","_super","apply","arguments","id","FunctionQueue","DOMQueue","nop","hasDOM","hasRAF","requestAnimationFrame","getHeight","getWidth","rAF","bind","meta","lastVersion","updateMeta","isDirty","IntersectionObserver","performance","innerHeight","innerWidth","readyState","addEventListener","reads","work","running","unshift","run","_this","rlen","pop","wlen","replace","r","random","toString","Frame","generate","root","rootMeta","revalidateRootMeta","Date","now","_clientRect","_rootMeta","BaseScheduler","customEngine","isTicking","toRemove","tick","queue","applyQueue","unwatch","unwatchAll","startTicking","watch","PredicatedScheduler","predicate","call","undefined","ElementScheduler","ALLOW_CACHED_SCHEDULER","defineProperty","get","enumerable","configurable","scheduler","cb","w","visibilityState","SpanielIntersectionObserver","options","records","threshold","rootMarginObj","isArray","thresholds","observe","trackedTarget","__spanielId","onTick","generateEntryEvent","numSatisfiedThresholds","record","unobserve","disconnect","takeRecords","count","SpanielObserver","paused","queuedEntries","recordStore","BACKGROUND_TAB_FIX","USE_NATIVE_IO","convertedRootMargin","sort","t","o","usingNativeIo","observer","internalCallback","onTabHidden","_onTabHidden","onWindowClosed","_onWindowClosed","onTabShown","_onTabShown","setAllHidden","ids","keys","handleRecordExiting","flushQueuedEntries","lastSeenEntry","handleObserverEntry","generateSpanielEntry","floor","timeOrigin","timing","navigationStart","Error","calculateDuration","compatTime","perfTime","thresholdStates","handleThresholdExiting","lastVisible","lastSatisfied","visible","lastEntry","spanielEntry","hasTimeThreshold","clearTimeout","timeoutId","ratioSatisfied","isSatisfied","timerId","Number","setTimeout","Watcher","config"],"mappings":"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","file":"spaniel.js","sourcesContent":["export function calculateIsIntersecting(_a) {\n    var intersectionRect = _a.intersectionRect;\n    return intersectionRect.width >= 0 && intersectionRect.height >= 0;\n}\nexport function getBoundingClientRect(element) {\n    try {\n        return element.getBoundingClientRect();\n    }\n    catch (e) {\n        if (typeof e === 'object' && e !== null && (e.number & 0xffff) === 16389) {\n            return { top: 0, bottom: 0, left: 0, width: 0, height: 0, right: 0, x: 0, y: 0 };\n        }\n        else {\n            throw e;\n        }\n    }\n}\nexport function throttle(cb, thottleDelay, scope) {\n    if (thottleDelay === void 0) { thottleDelay = 5; }\n    if (scope === void 0) { scope = window; }\n    var cookie;\n    return function () {\n        scope.clearTimeout(cookie);\n        cookie = scope.setTimeout(cb, thottleDelay);\n    };\n}\n//# sourceMappingURL=utils.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nvar nop = function () { return 0; };\nvar hasDOM = !!(typeof window !== 'undefined' && window && typeof document !== 'undefined' && document);\nvar hasRAF = hasDOM && !!window.requestAnimationFrame;\nvar W = {\n    hasDOM: hasDOM,\n    hasRAF: hasRAF,\n    getScrollTop: nop,\n    getScrollLeft: nop,\n    getHeight: nop,\n    getWidth: nop,\n    rAF: hasRAF\n        ? window.requestAnimationFrame.bind(window)\n        : function (callback) {\n            callback();\n        },\n    meta: {\n        width: 0,\n        height: 0,\n        scrollTop: 0,\n        scrollLeft: 0,\n        x: 0,\n        y: 0,\n        top: 0,\n        left: 0\n    },\n    version: 0,\n    lastVersion: 0,\n    updateMeta: nop,\n    get isDirty() {\n        return W.version !== W.lastVersion;\n    },\n    document: window.document,\n    IntersectionObserver: hasDOM && window.IntersectionObserver,\n    performance: hasDOM && window.performance\n};\nexport function invalidate() {\n    ++W.version;\n}\n// Init after DOM Content has loaded\nfunction hasDomSetup() {\n    var se = document.scrollingElement != null;\n    W.getScrollTop = se ? function () { return document.scrollingElement.scrollTop; } : function () { return window.scrollY; };\n    W.getScrollLeft = se ? function () { return document.scrollingElement.scrollLeft; } : function () { return window.scrollX; };\n}\nif (hasDOM) {\n    // Set the height and width immediately because they will be available at this point\n    W.getHeight = function () { return window.innerHeight; };\n    W.getWidth = function () { return window.innerWidth; };\n    W.updateMeta = function () {\n        W.meta.height = W.getHeight();\n        W.meta.width = W.getWidth();\n        W.meta.scrollLeft = W.getScrollLeft();\n        W.meta.scrollTop = W.getScrollTop();\n        W.lastVersion = W.version;\n    };\n    W.updateMeta();\n    if (document.readyState !== 'loading') {\n        hasDomSetup();\n    }\n    else {\n        document.addEventListener('DOMContentLoaded', hasDomSetup);\n    }\n    window.addEventListener('resize', invalidate, false);\n    window.addEventListener('scroll', invalidate, false);\n}\nexport default W;\n//# sourceMappingURL=window-proxy.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport W from './window-proxy';\nvar Engine = /** @class */ (function () {\n    function Engine() {\n        this.reads = [];\n        this.work = [];\n        this.running = false;\n    }\n    Engine.prototype.scheduleRead = function (callback) {\n        this.reads.unshift(callback);\n        this.run();\n    };\n    Engine.prototype.scheduleWork = function (callback) {\n        this.work.unshift(callback);\n        this.run();\n    };\n    Engine.prototype.run = function () {\n        var _this = this;\n        if (!this.running) {\n            this.running = true;\n            W.rAF(function () {\n                _this.running = false;\n                for (var i = 0, rlen = _this.reads.length; i < rlen; i++) {\n                    _this.reads.pop()();\n                }\n                for (var i = 0, wlen = _this.work.length; i < wlen; i++) {\n                    _this.work.pop()();\n                }\n                if (_this.work.length > 0 || _this.reads.length > 0) {\n                    _this.run();\n                }\n            });\n        }\n    };\n    return Engine;\n}());\nexport { Engine };\nvar globalEngine = null;\nexport function setGlobalEngine(engine) {\n    if (!!globalEngine) {\n        return false;\n    }\n    globalEngine = engine;\n    return true;\n}\nexport function getGlobalEngine() {\n    return globalEngine || (globalEngine = new Engine());\n}\n//# sourceMappingURL=engine.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nimport W from './window-proxy';\nimport { default as Queue, DOMQueue } from './queue';\nimport { getGlobalEngine } from './engine';\nimport { getBoundingClientRect } from '../utils';\nvar TOKEN_SEED = 'xxxx'.replace(/[xy]/g, function (c) {\n    var r = (Math.random() * 16) | 0, v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n});\nvar tokenCounter = 0;\nvar Frame = /** @class */ (function () {\n    function Frame(dateNow, highResTime, scrollTop, scrollLeft, width, height, x, y, top, left) {\n        this.dateNow = dateNow;\n        this.highResTime = highResTime;\n        this.scrollTop = scrollTop;\n        this.scrollLeft = scrollLeft;\n        this.width = width;\n        this.height = height;\n        this.x = x;\n        this.y = y;\n        this.top = top;\n        this.left = left;\n    }\n    Frame.generate = function (root) {\n        if (root === void 0) { root = window; }\n        var rootMeta = this.revalidateRootMeta(root);\n        return new Frame(Date.now(), performance.now(), rootMeta.scrollTop, rootMeta.scrollLeft, rootMeta.width, rootMeta.height, rootMeta.x, rootMeta.y, rootMeta.top, rootMeta.left);\n    };\n    Frame.revalidateRootMeta = function (root) {\n        if (root === void 0) { root = document; }\n        var _clientRect = null;\n        var _rootMeta = {\n            width: 0,\n            height: 0,\n            scrollTop: 0,\n            scrollLeft: 0,\n            x: 0,\n            y: 0,\n            top: 0,\n            left: 0\n        };\n        // if root is dirty update the cached values\n        if (W.isDirty) {\n            W.updateMeta();\n        }\n        if (root === window || root === document) {\n            _rootMeta.height = W.meta.height;\n            _rootMeta.width = W.meta.width;\n            _rootMeta.scrollLeft = W.meta.scrollLeft;\n            _rootMeta.scrollTop = W.meta.scrollTop;\n            return _rootMeta;\n        }\n        _clientRect = getBoundingClientRect(root);\n        _rootMeta.scrollTop = root.scrollTop;\n        _rootMeta.scrollLeft = root.scrollLeft;\n        _rootMeta.width = _clientRect.width;\n        _rootMeta.height = _clientRect.height;\n        _rootMeta.x = _clientRect.x;\n        _rootMeta.y = _clientRect.y;\n        _rootMeta.top = _clientRect.top;\n        _rootMeta.left = _clientRect.left;\n        return _rootMeta;\n    };\n    return Frame;\n}());\nexport { Frame };\nexport function generateToken() {\n    return tokenCounter++ + TOKEN_SEED;\n}\nvar BaseScheduler = /** @class */ (function () {\n    function BaseScheduler(customEngine, root) {\n        this.isTicking = false;\n        this.toRemove = [];\n        if (customEngine) {\n            this.engine = customEngine;\n        }\n        else {\n            this.engine = getGlobalEngine();\n        }\n        this.root = root || window;\n    }\n    BaseScheduler.prototype.tick = function () {\n        if (this.queue.isEmpty()) {\n            this.isTicking = false;\n        }\n        else {\n            if (this.toRemove.length > 0) {\n                for (var i = 0; i < this.toRemove.length; i++) {\n                    this.queue.remove(this.toRemove[i]);\n                }\n                this.toRemove = [];\n            }\n            this.applyQueue(Frame.generate(this.root));\n            this.engine.scheduleRead(this.tick.bind(this));\n        }\n    };\n    BaseScheduler.prototype.scheduleWork = function (callback) {\n        this.engine.scheduleWork(callback);\n    };\n    BaseScheduler.prototype.scheduleRead = function (callback) {\n        this.engine.scheduleRead(callback);\n    };\n    BaseScheduler.prototype.queryElement = function (el, callback) {\n        var _this = this;\n        var clientRect;\n        var frame;\n        this.engine.scheduleRead(function () {\n            clientRect = getBoundingClientRect(el);\n            frame = Frame.generate(_this.root);\n        });\n        this.engine.scheduleWork(function () {\n            callback(clientRect, frame);\n        });\n    };\n    BaseScheduler.prototype.unwatch = function (id) {\n        this.toRemove.push(id);\n    };\n    BaseScheduler.prototype.unwatchAll = function () {\n        this.queue.clear();\n    };\n    BaseScheduler.prototype.startTicking = function () {\n        if (!this.isTicking) {\n            this.isTicking = true;\n            this.engine.scheduleRead(this.tick.bind(this));\n        }\n    };\n    return BaseScheduler;\n}());\nexport { BaseScheduler };\nvar Scheduler = /** @class */ (function (_super) {\n    __extends(Scheduler, _super);\n    function Scheduler() {\n        var _this = _super !== null && _super.apply(this, arguments) || this;\n        _this.queue = new Queue();\n        return _this;\n    }\n    Scheduler.prototype.applyQueue = function (frame) {\n        for (var i = 0; i < this.queue.items.length; i++) {\n            var _a = this.queue.items[i], id = _a.id, callback = _a.callback;\n            callback(frame, id);\n        }\n    };\n    Scheduler.prototype.watch = function (callback) {\n        this.startTicking();\n        var id = generateToken();\n        this.queue.push({\n            callback: callback,\n            id: id\n        });\n        return id;\n    };\n    return Scheduler;\n}(BaseScheduler));\nexport { Scheduler };\nvar PredicatedScheduler = /** @class */ (function (_super) {\n    __extends(PredicatedScheduler, _super);\n    function PredicatedScheduler(predicate) {\n        var _this = _super.call(this, undefined, window) || this;\n        _this.predicate = predicate;\n        return _this;\n    }\n    PredicatedScheduler.prototype.applyQueue = function (frame) {\n        if (this.predicate(frame)) {\n            _super.prototype.applyQueue.call(this, frame);\n        }\n    };\n    return PredicatedScheduler;\n}(Scheduler));\nexport { PredicatedScheduler };\nvar ElementScheduler = /** @class */ (function (_super) {\n    __extends(ElementScheduler, _super);\n    function ElementScheduler(customEngine, root, ALLOW_CACHED_SCHEDULER) {\n        if (ALLOW_CACHED_SCHEDULER === void 0) { ALLOW_CACHED_SCHEDULER = false; }\n        var _this = _super.call(this, customEngine, root) || this;\n        _this.lastVersion = W.version;\n        _this.queue = new DOMQueue();\n        _this.ALLOW_CACHED_SCHEDULER = ALLOW_CACHED_SCHEDULER;\n        return _this;\n    }\n    Object.defineProperty(ElementScheduler.prototype, \"isDirty\", {\n        get: function () {\n            return W.version !== this.lastVersion;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    ElementScheduler.prototype.applyQueue = function (frame) {\n        for (var i = 0; i < this.queue.items.length; i++) {\n            var _a = this.queue.items[i], callback = _a.callback, el = _a.el, id = _a.id, clientRect = _a.clientRect;\n            if (this.isDirty || !clientRect || !this.ALLOW_CACHED_SCHEDULER) {\n                clientRect = this.queue.items[i].clientRect = getBoundingClientRect(el);\n            }\n            callback(frame, id, clientRect);\n        }\n        this.lastVersion = W.version;\n    };\n    ElementScheduler.prototype.watch = function (el, callback, id) {\n        this.startTicking();\n        id = id || generateToken();\n        var clientRect = null;\n        this.queue.push({\n            el: el,\n            callback: callback,\n            id: id,\n            clientRect: clientRect\n        });\n        return id;\n    };\n    return ElementScheduler;\n}(BaseScheduler));\nexport { ElementScheduler };\nvar globalScheduler = null;\nexport function getGlobalScheduler() {\n    return globalScheduler || (globalScheduler = new Scheduler());\n}\n//# sourceMappingURL=scheduler.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport { Frame, PredicatedScheduler, FunctionQueue, getGlobalScheduler } from './index';\nimport w from './window-proxy';\nvar GenericEventRecord = /** @class */ (function () {\n    function GenericEventRecord() {\n        this.queue = new FunctionQueue();\n    }\n    GenericEventRecord.prototype.listen = function (callback) {\n        this.queue.push(callback);\n    };\n    GenericEventRecord.prototype.unlisten = function (callback) {\n        this.queue.remove(callback);\n    };\n    GenericEventRecord.prototype.trigger = function (value) {\n        for (var i = 0; i < this.queue.items.length; i++) {\n            this.queue.items[i](value);\n        }\n    };\n    return GenericEventRecord;\n}());\nvar RAFEventRecord = /** @class */ (function () {\n    function RAFEventRecord(predicate) {\n        this.scheduler = new PredicatedScheduler(predicate.bind(this));\n    }\n    RAFEventRecord.prototype.trigger = function () { };\n    RAFEventRecord.prototype.listen = function (callback) {\n        this.state = Frame.generate();\n        this.scheduler.watch(callback);\n    };\n    RAFEventRecord.prototype.unlisten = function (cb) {\n        this.scheduler.unwatch(cb);\n    };\n    return RAFEventRecord;\n}());\nvar eventStore = null;\nfunction getEventStore() {\n    return (eventStore ||\n        (eventStore = {\n            scroll: new RAFEventRecord(function (frame) {\n                var _a = this.state, scrollTop = _a.scrollTop, scrollLeft = _a.scrollLeft;\n                this.state = frame;\n                return scrollTop !== frame.scrollTop || scrollLeft !== frame.scrollLeft;\n            }),\n            resize: new RAFEventRecord(function (frame) {\n                var _a = this.state, width = _a.width, height = _a.height;\n                this.state = frame;\n                return height !== frame.height || width !== frame.width;\n            }),\n            destroy: new GenericEventRecord(),\n            beforeunload: new GenericEventRecord(),\n            hide: new GenericEventRecord(),\n            show: new GenericEventRecord()\n        }));\n}\nif (w.hasDOM) {\n    window.addEventListener('beforeunload', function () {\n        // First fire internal event to fire any observer callbacks\n        trigger('beforeunload');\n        // Then fire external event to allow flushing of any beacons\n        trigger('destroy');\n    });\n    document.addEventListener('visibilitychange', function onVisibilityChange() {\n        if (document.visibilityState === 'visible') {\n            trigger('show');\n        }\n        else {\n            trigger('hide');\n        }\n    });\n}\nexport function on(eventName, callback) {\n    var evt = getEventStore()[eventName];\n    if (evt) {\n        evt.listen(callback);\n    }\n}\nexport function off(eventName, callback) {\n    if (eventStore) {\n        var evt = eventStore[eventName];\n        if (evt) {\n            evt.unlisten(callback);\n        }\n    }\n}\nexport function trigger(eventName, value) {\n    if (eventStore) {\n        var evt = eventStore[eventName];\n        if (evt) {\n            evt.trigger(value);\n        }\n    }\n}\n/**\n * Schedule a callback to be batched along with other DOM read/query work.\n * Use to schedule any DOM reads. Doing so will avoid DOM thrashing.\n */\nexport function scheduleWork(callback) {\n    getGlobalScheduler().scheduleWork(callback);\n}\n/**\n * Schedule a callback to be batched along with other DOM write/mutation\n * work. Use to schedule any DOM changes. Doing so will avoid DOM thrashing.\n */\nexport function scheduleRead(callback) {\n    getGlobalScheduler().scheduleRead(callback);\n}\n//# sourceMappingURL=events.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport { calculateIsIntersecting } from './utils';\nimport { ElementScheduler, generateToken } from './metal/index';\nfunction marginToRect(margin) {\n    var left = margin.left, right = margin.right, top = margin.top, bottom = margin.bottom;\n    return {\n        left: left,\n        top: top,\n        bottom: bottom,\n        right: right,\n        width: right - left,\n        height: bottom - top,\n        x: left,\n        y: top\n    };\n}\nfunction rootMarginToDOMMargin(rootMargin) {\n    var c = rootMargin.split(' ').map(function (n) { return parseInt(n, 10); });\n    switch (c.length) {\n        case 2:\n            return { top: c[0], left: c[1], bottom: c[0], right: c[1] };\n        case 3:\n            return { top: c[0], left: c[1], bottom: c[2], right: c[1] };\n        case 4:\n            return { top: c[0], left: c[1], bottom: c[2], right: c[3] };\n        default:\n            return { top: 0, left: 0, bottom: 0, right: 0 };\n    }\n}\nvar SpanielIntersectionObserver = /** @class */ (function () {\n    function SpanielIntersectionObserver(callback, options) {\n        if (options === void 0) { options = {}; }\n        this.records = {};\n        this.callback = callback;\n        options.threshold = options.threshold || 0;\n        this.rootMarginObj = rootMarginToDOMMargin(options.rootMargin || '0px');\n        this.root = options.root || null;\n        if (Array.isArray(options.threshold)) {\n            this.thresholds = options.threshold;\n        }\n        else {\n            this.thresholds = [options.threshold];\n        }\n        this.scheduler = new ElementScheduler(undefined, this.root, options.ALLOW_CACHED_SCHEDULER);\n    }\n    SpanielIntersectionObserver.prototype.observe = function (target) {\n        var _this = this;\n        var trackedTarget = target;\n        var id = (trackedTarget.__spanielId = trackedTarget.__spanielId || generateToken());\n        this.scheduler.watch(target, function (frame, id, clientRect) {\n            _this.onTick(frame, id, clientRect, trackedTarget);\n        }, trackedTarget.__spanielId);\n        return id;\n    };\n    SpanielIntersectionObserver.prototype.onTick = function (frame, id, clientRect, el) {\n        var _this = this;\n        var _a = this.generateEntryEvent(frame, clientRect, el), numSatisfiedThresholds = _a.numSatisfiedThresholds, entry = _a.entry;\n        var record = this.records[id] ||\n            (this.records[id] = {\n                entry: entry,\n                numSatisfiedThresholds: 0\n            });\n        if (numSatisfiedThresholds !== record.numSatisfiedThresholds ||\n            entry.isIntersecting !== record.entry.isIntersecting) {\n            record.numSatisfiedThresholds = numSatisfiedThresholds;\n            record.entry = entry;\n            this.scheduler.scheduleWork(function () {\n                _this.callback([entry]);\n            });\n        }\n    };\n    SpanielIntersectionObserver.prototype.unobserve = function (target) {\n        this.scheduler.unwatch(target.__spanielId);\n        delete this.records[target.__spanielId];\n    };\n    SpanielIntersectionObserver.prototype.disconnect = function () {\n        this.scheduler.unwatchAll();\n        this.records = {};\n    };\n    SpanielIntersectionObserver.prototype.takeRecords = function () {\n        return [];\n    };\n    SpanielIntersectionObserver.prototype.generateEntryEvent = function (frame, clientRect, el) {\n        var count = 0;\n        var entry = generateEntry(frame, clientRect, el, this.rootMarginObj);\n        for (var i = 0; i < this.thresholds.length; i++) {\n            var threshold = this.thresholds[i];\n            if (entry.intersectionRatio >= threshold) {\n                count++;\n            }\n        }\n        return {\n            numSatisfiedThresholds: count,\n            entry: entry\n        };\n    };\n    return SpanielIntersectionObserver;\n}());\nexport { SpanielIntersectionObserver };\nfunction addRatio(entryInit) {\n    var unixTime = entryInit.unixTime, highResTime = entryInit.highResTime, rootBounds = entryInit.rootBounds, boundingClientRect = entryInit.boundingClientRect, intersectionRect = entryInit.intersectionRect, target = entryInit.target;\n    var boundingArea = boundingClientRect.height * boundingClientRect.width;\n    var intersectionRatio = boundingArea > 0 ? (intersectionRect.width * intersectionRect.height) / boundingArea : 0;\n    return {\n        time: unixTime,\n        unixTime: unixTime,\n        highResTime: highResTime,\n        rootBounds: rootBounds,\n        boundingClientRect: boundingClientRect,\n        intersectionRect: intersectionRect,\n        target: target,\n        intersectionRatio: intersectionRatio,\n        isIntersecting: calculateIsIntersecting({ intersectionRect: intersectionRect })\n    };\n}\nfunction emptyRect() {\n    return {\n        bottom: 0,\n        height: 0,\n        left: 0,\n        right: 0,\n        top: 0,\n        width: 0,\n        x: 0,\n        y: 0\n    };\n}\nexport function generateEntry(frame, clientRect, el, rootMargin) {\n    if (el.style.display === 'none') {\n        return {\n            unixTime: frame.dateNow,\n            highResTime: frame.highResTime,\n            boundingClientRect: emptyRect(),\n            intersectionRatio: 0,\n            intersectionRect: emptyRect(),\n            isIntersecting: false,\n            rootBounds: emptyRect(),\n            target: el,\n            time: frame.dateNow\n        };\n    }\n    var bottom = clientRect.bottom, right = clientRect.right;\n    var left = frame.left + rootMargin.left;\n    var top = frame.top + rootMargin.top;\n    var rootBounds = {\n        left: left,\n        top: top,\n        bottom: rootMargin.bottom,\n        right: rootMargin.right,\n        width: frame.width - (rootMargin.right + rootMargin.left),\n        height: frame.height - (rootMargin.bottom + rootMargin.top),\n        y: top,\n        x: left\n    };\n    var intersectX = Math.max(rootBounds.left, clientRect.left);\n    var intersectY = Math.max(rootBounds.top, clientRect.top);\n    var width = Math.min(rootBounds.left + rootBounds.width, clientRect.right) - intersectX;\n    var height = Math.min(rootBounds.top + rootBounds.height, clientRect.bottom) - intersectY;\n    var interLeft = width >= 0 ? intersectX : 0;\n    var interTop = intersectY >= 0 ? intersectY : 0;\n    var intersectionRect = {\n        left: interLeft,\n        top: interTop,\n        x: interLeft,\n        y: interTop,\n        width: width,\n        height: height,\n        right: right,\n        bottom: bottom\n    };\n    return addRatio({\n        unixTime: frame.dateNow,\n        highResTime: frame.highResTime,\n        rootBounds: rootBounds,\n        target: el,\n        boundingClientRect: marginToRect(clientRect),\n        intersectionRect: intersectionRect\n    });\n}\n//# sourceMappingURL=intersection-observer.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport { SpanielIntersectionObserver } from './intersection-observer';\nimport { generateToken, off, on, scheduleWork } from './metal/index';\nimport w from './metal/window-proxy';\nimport { calculateIsIntersecting } from './utils';\nvar emptyRect = { x: 0, y: 0, width: 0, height: 0 };\nexport function DOMMarginToRootMargin(d) {\n    return d.top + \"px \" + d.right + \"px \" + d.bottom + \"px \" + d.left + \"px\";\n}\nvar SpanielObserver = /** @class */ (function () {\n    function SpanielObserver(callback, options) {\n        var _this = this;\n        this.paused = false;\n        this.queuedEntries = [];\n        this.recordStore = {};\n        this.callback = callback;\n        var _a = options ||\n            {\n                threshold: []\n            }, root = _a.root, rootMargin = _a.rootMargin, threshold = _a.threshold, ALLOW_CACHED_SCHEDULER = _a.ALLOW_CACHED_SCHEDULER, BACKGROUND_TAB_FIX = _a.BACKGROUND_TAB_FIX, USE_NATIVE_IO = _a.USE_NATIVE_IO;\n        rootMargin = rootMargin || '0px';\n        var convertedRootMargin = typeof rootMargin !== 'string' ? DOMMarginToRootMargin(rootMargin) : rootMargin;\n        this.thresholds = threshold.sort(function (t) { return t.ratio; });\n        var o = {\n            root: root,\n            rootMargin: convertedRootMargin,\n            threshold: this.thresholds.map(function (t) { return t.ratio; }),\n            ALLOW_CACHED_SCHEDULER: ALLOW_CACHED_SCHEDULER\n        };\n        this.usingNativeIo = !!USE_NATIVE_IO && !!w.IntersectionObserver;\n        var IntersectionObserver = this.usingNativeIo ? w.IntersectionObserver : SpanielIntersectionObserver;\n        this.observer = new IntersectionObserver(function (records) { return _this.internalCallback(records); }, o);\n        this.onTabHidden = this._onTabHidden.bind(this);\n        this.onWindowClosed = this._onWindowClosed.bind(this);\n        this.onTabShown = this._onTabShown.bind(this);\n        if (w.hasDOM) {\n            on('beforeunload', this.onWindowClosed);\n            on('hide', this.onTabHidden);\n            on('show', this.onTabShown);\n            if (BACKGROUND_TAB_FIX) {\n                this.paused = w.document.visibilityState !== 'visible';\n            }\n        }\n    }\n    SpanielObserver.prototype._onWindowClosed = function () {\n        this.onTabHidden();\n    };\n    SpanielObserver.prototype.setAllHidden = function () {\n        var ids = Object.keys(this.recordStore);\n        for (var i = 0; i < ids.length; i++) {\n            this.handleRecordExiting(this.recordStore[ids[i]]);\n        }\n        this.flushQueuedEntries();\n    };\n    SpanielObserver.prototype._onTabHidden = function () {\n        this.paused = true;\n        this.setAllHidden();\n    };\n    SpanielObserver.prototype._onTabShown = function () {\n        this.paused = false;\n        var ids = Object.keys(this.recordStore);\n        var highResTime = performance.now();\n        var unixTime = Date.now();\n        for (var i = 0; i < ids.length; i++) {\n            var entry = this.recordStore[ids[i]].lastSeenEntry;\n            if (entry) {\n                var intersectionRatio = entry.intersectionRatio, boundingClientRect = entry.boundingClientRect, rootBounds = entry.rootBounds, intersectionRect = entry.intersectionRect, isIntersecting = entry.isIntersecting, target = entry.target;\n                this.handleObserverEntry({\n                    intersectionRatio: intersectionRatio,\n                    boundingClientRect: boundingClientRect,\n                    time: unixTime,\n                    highResTime: highResTime,\n                    unixTime: unixTime,\n                    isIntersecting: isIntersecting,\n                    rootBounds: rootBounds,\n                    intersectionRect: intersectionRect,\n                    target: target\n                });\n            }\n        }\n    };\n    SpanielObserver.prototype.internalCallback = function (records) {\n        records.forEach(this.handleObserverEntry.bind(this));\n    };\n    SpanielObserver.prototype.flushQueuedEntries = function () {\n        if (this.queuedEntries.length > 0) {\n            this.callback(this.queuedEntries);\n            this.queuedEntries = [];\n        }\n    };\n    SpanielObserver.prototype.generateSpanielEntry = function (entry, state) {\n        var intersectionRatio = entry.intersectionRatio, rootBounds = entry.rootBounds, boundingClientRect = entry.boundingClientRect, intersectionRect = entry.intersectionRect, isIntersecting = entry.isIntersecting, time = entry.time, target = entry.target;\n        var record = this.recordStore[target.__spanielId];\n        var unixTime = this.usingNativeIo\n            ? Math.floor(w.performance.timeOrigin || w.performance.timing.navigationStart + time)\n            : time;\n        var highResTime = this.usingNativeIo ? time : entry.highResTime;\n        if (!highResTime) {\n            throw new Error('Missing high res timestamp');\n        }\n        return {\n            intersectionRatio: intersectionRatio,\n            isIntersecting: isIntersecting,\n            unixTime: unixTime,\n            highResTime: highResTime,\n            rootBounds: rootBounds,\n            boundingClientRect: boundingClientRect,\n            intersectionRect: intersectionRect,\n            target: target,\n            duration: 0,\n            entering: false,\n            payload: record.payload,\n            label: state.threshold.label\n        };\n    };\n    SpanielObserver.prototype.calculateDuration = function (compatTime, unixTime, highResTime) {\n        return this.usingNativeIo ? highResTime - compatTime.highResTime : unixTime - compatTime.unixTime;\n    };\n    SpanielObserver.prototype.handleRecordExiting = function (record) {\n        var _this = this;\n        var time = Date.now();\n        var perfTime = performance.now();\n        record.thresholdStates.forEach(function (state) {\n            var boundingClientRect = record.lastSeenEntry && record.lastSeenEntry.boundingClientRect;\n            _this.handleThresholdExiting({\n                intersectionRatio: -1,\n                isIntersecting: false,\n                unixTime: time,\n                highResTime: perfTime,\n                payload: record.payload,\n                label: state.threshold.label,\n                entering: false,\n                rootBounds: emptyRect,\n                boundingClientRect: boundingClientRect || emptyRect,\n                intersectionRect: emptyRect,\n                duration: _this.calculateDuration(state.lastVisible, time, perfTime),\n                target: record.target\n            }, state);\n            state.lastSatisfied = false;\n            state.visible = false;\n            state.lastEntry = null;\n        });\n    };\n    SpanielObserver.prototype.handleThresholdExiting = function (spanielEntry, state) {\n        var highResTime = spanielEntry.highResTime;\n        var hasTimeThreshold = !!state.threshold.time;\n        if (state.lastSatisfied && (!hasTimeThreshold || (hasTimeThreshold && state.visible))) {\n            // Make into function\n            spanielEntry.duration = highResTime - state.lastVisible.highResTime;\n            spanielEntry.entering = false;\n            state.visible = false;\n            this.queuedEntries.push(spanielEntry);\n        }\n        clearTimeout(state.timeoutId);\n    };\n    SpanielObserver.prototype.handleObserverEntry = function (entry) {\n        var _this = this;\n        var target = entry.target;\n        var record = this.recordStore[target.__spanielId];\n        if (record) {\n            record.lastSeenEntry = entry;\n            if (!this.paused) {\n                record.thresholdStates.forEach(function (state) {\n                    // Find the thresholds that were crossed. Since you can have multiple thresholds\n                    // for the same ratio, could be multiple thresholds\n                    var hasTimeThreshold = !!state.threshold.time;\n                    var spanielEntry = _this.generateSpanielEntry(entry, state);\n                    var ratioSatisfied = entry.intersectionRatio >= state.threshold.ratio;\n                    // The spaniel polyfill doesn't have isIntersecting, so only calculate if it doesn't exist, i.e. we aren't using\n                    // the native intersectionobserver\n                    var isIntersecting = typeof spanielEntry.isIntersecting === 'boolean'\n                        ? spanielEntry.isIntersecting\n                        : calculateIsIntersecting(entry);\n                    var isSatisfied = ratioSatisfied && isIntersecting;\n                    if (isSatisfied != state.lastSatisfied) {\n                        if (isSatisfied) {\n                            spanielEntry.entering = true;\n                            if (hasTimeThreshold) {\n                                state.lastVisible = {\n                                    highResTime: spanielEntry.highResTime,\n                                    unixTime: spanielEntry.unixTime\n                                };\n                                var timerId = Number(setTimeout(function () {\n                                    state.visible = true;\n                                    spanielEntry.duration = performance.now() - state.lastVisible.highResTime;\n                                    _this.callback([spanielEntry]);\n                                }, state.threshold.time));\n                                state.timeoutId = timerId;\n                            }\n                            else {\n                                state.visible = true;\n                                _this.queuedEntries.push(spanielEntry);\n                            }\n                        }\n                        else {\n                            _this.handleThresholdExiting(spanielEntry, state);\n                        }\n                        state.lastEntry = entry;\n                        state.lastSatisfied = isSatisfied;\n                    }\n                });\n                this.flushQueuedEntries();\n            }\n        }\n    };\n    SpanielObserver.prototype.disconnect = function () {\n        this.setAllHidden();\n        this.observer.disconnect();\n        this.recordStore = {};\n    };\n    /*\n     * Must be called when the SpanielObserver is done being used.\n     * This will prevent memory leaks.\n     */\n    SpanielObserver.prototype.destroy = function () {\n        this.disconnect();\n        if (w.hasDOM) {\n            off('beforeunload', this.onWindowClosed);\n            off('hide', this.onTabHidden);\n            off('show', this.onTabShown);\n        }\n    };\n    SpanielObserver.prototype.unobserve = function (element) {\n        var _this = this;\n        var record = this.recordStore[element.__spanielId];\n        if (record) {\n            delete this.recordStore[element.__spanielId];\n            this.observer.unobserve(element);\n            scheduleWork(function () {\n                _this.handleRecordExiting(record);\n                _this.flushQueuedEntries();\n            });\n        }\n    };\n    SpanielObserver.prototype.observe = function (target, payload) {\n        if (payload === void 0) { payload = null; }\n        var trackedTarget = target;\n        var id = (trackedTarget.__spanielId = trackedTarget.__spanielId || generateToken());\n        this.recordStore[id] = {\n            target: trackedTarget,\n            payload: payload,\n            lastSeenEntry: null,\n            thresholdStates: this.thresholds.map(function (threshold) { return ({\n                lastSatisfied: false,\n                lastEntry: null,\n                threshold: threshold,\n                visible: false,\n                lastVisible: {\n                    unixTime: 0,\n                    highResTime: -1\n                }\n            }); })\n        };\n        this.observer.observe(trackedTarget);\n        return id;\n    };\n    return SpanielObserver;\n}());\nexport { SpanielObserver };\n//# sourceMappingURL=spaniel-observer.js.map","/*\nCopyright 2016 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport { SpanielObserver } from './spaniel-observer';\nfunction onEntry(entries) {\n    entries.forEach(function (entry) {\n        var label = entry.label, duration = entry.duration, boundingClientRect = entry.boundingClientRect, intersectionRect = entry.intersectionRect;\n        var opts = {\n            duration: duration,\n            boundingClientRect: boundingClientRect,\n            visibleTime: entry.unixTime,\n            intersectionRect: intersectionRect\n        };\n        if (entry.entering) {\n            entry.payload.callback(label, opts);\n        }\n        else if (entry.label === 'impressed') {\n            opts.visibleTime = entry.highResTime - entry.duration;\n            entry.payload.callback('impression-complete', opts);\n        }\n    });\n}\nvar Watcher = /** @class */ (function () {\n    function Watcher(config) {\n        if (config === void 0) { config = {}; }\n        var time = config.time, ratio = config.ratio, rootMargin = config.rootMargin, root = config.root, ALLOW_CACHED_SCHEDULER = config.ALLOW_CACHED_SCHEDULER, BACKGROUND_TAB_FIX = config.BACKGROUND_TAB_FIX, USE_NATIVE_IO = config.USE_NATIVE_IO;\n        var threshold = [\n            {\n                label: 'exposed',\n                time: 0,\n                ratio: 0\n            }\n        ];\n        if (time) {\n            threshold.push({\n                label: 'impressed',\n                time: time,\n                ratio: ratio || 0\n            });\n        }\n        if (ratio) {\n            threshold.push({\n                label: 'visible',\n                time: 0,\n                ratio: ratio\n            });\n        }\n        this.observer = new SpanielObserver(onEntry, {\n            rootMargin: rootMargin,\n            threshold: threshold,\n            root: root,\n            ALLOW_CACHED_SCHEDULER: ALLOW_CACHED_SCHEDULER,\n            BACKGROUND_TAB_FIX: BACKGROUND_TAB_FIX,\n            USE_NATIVE_IO: USE_NATIVE_IO\n        });\n    }\n    Watcher.prototype.watch = function (el, callback) {\n        this.observer.observe(el, {\n            callback: callback\n        });\n    };\n    Watcher.prototype.unwatch = function (el) {\n        this.observer.unobserve(el);\n    };\n    Watcher.prototype.disconnect = function () {\n        this.observer.disconnect();\n    };\n    /*\n     * Must be called when the Watcher is done being used.\n     * This will prevent memory leaks.\n     */\n    Watcher.prototype.destroy = function () {\n        this.observer.destroy();\n    };\n    return Watcher;\n}());\nexport { Watcher };\n//# sourceMappingURL=watcher.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nimport { SpanielIntersectionObserver, generateEntry } from './intersection-observer';\nexport { Watcher } from './watcher';\nimport { SpanielObserver } from './spaniel-observer';\nimport { setGlobalEngine, getGlobalEngine } from './metal/engine';\nimport { getGlobalScheduler, on, off, scheduleWork, scheduleRead } from './metal/index';\nimport w from './metal/window-proxy';\nimport { invalidate } from './metal/window-proxy';\nvar IntersectionObserver = !!w.IntersectionObserver\n    ? w.IntersectionObserver\n    : SpanielIntersectionObserver;\nexport { on, off, scheduleRead, scheduleWork, IntersectionObserver, SpanielObserver, setGlobalEngine, getGlobalEngine, w as __w__, invalidate };\nexport function queryElement(el, callback) {\n    getGlobalScheduler().queryElement(el, callback);\n}\nexport function elementSatisfiesRatio(el, ratio, callback, rootMargin) {\n    if (ratio === void 0) { ratio = 0; }\n    if (rootMargin === void 0) { rootMargin = { top: 0, bottom: 0, left: 0, right: 0 }; }\n    queryElement(el, function (clientRect, frame) {\n        var entry = generateEntry(frame, clientRect, el, rootMargin);\n        callback(entry.isIntersecting && entry.intersectionRatio >= ratio);\n    });\n}\n//# sourceMappingURL=index.js.map","/*\nCopyright 2017 LinkedIn Corp. Licensed under the Apache License,\nVersion 2.0 (the \"License\"); you may not use this file except in\ncompliance with the License. You may obtain a copy of the License\nat http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n*/\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar BaseQueue = /** @class */ (function () {\n    function BaseQueue() {\n        this.items = [];\n    }\n    BaseQueue.prototype.remove = function (identifier) {\n        var len = this.items.length;\n        for (var i = 0; i < len; i++) {\n            if (this.removePredicate(identifier, this.items[i])) {\n                this.items.splice(i, 1);\n                i--;\n                len--;\n            }\n        }\n    };\n    BaseQueue.prototype.clear = function () {\n        this.items = [];\n    };\n    BaseQueue.prototype.push = function (element) {\n        this.items.push(element);\n    };\n    BaseQueue.prototype.isEmpty = function () {\n        return this.items.length === 0;\n    };\n    return BaseQueue;\n}());\nexport { BaseQueue };\nvar Queue = /** @class */ (function (_super) {\n    __extends(Queue, _super);\n    function Queue() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    Queue.prototype.removePredicate = function (identifier, element) {\n        if (typeof identifier === 'string') {\n            return element.id === identifier;\n        }\n        else {\n            return element.callback === identifier;\n        }\n    };\n    return Queue;\n}(BaseQueue));\nexport default Queue;\nvar FunctionQueue = /** @class */ (function (_super) {\n    __extends(FunctionQueue, _super);\n    function FunctionQueue() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    FunctionQueue.prototype.removePredicate = function (identifier, element) {\n        return element === identifier;\n    };\n    return FunctionQueue;\n}(BaseQueue));\nexport { FunctionQueue };\nvar DOMQueue = /** @class */ (function (_super) {\n    __extends(DOMQueue, _super);\n    function DOMQueue() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    DOMQueue.prototype.removePredicate = function (identifier, element) {\n        if (typeof identifier === 'string') {\n            return element.id === identifier;\n        }\n        else if (typeof identifier === 'function') {\n            return element.callback === identifier;\n        }\n        else {\n            return element.el === identifier;\n        }\n    };\n    return DOMQueue;\n}(BaseQueue));\nexport { DOMQueue };\n//# sourceMappingURL=queue.js.map"]}